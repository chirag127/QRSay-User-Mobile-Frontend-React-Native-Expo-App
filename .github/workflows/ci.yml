name: CI/CD Pipeline - Mobile Verification

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  quality_gates:
    name: "‚ôûÔ∏è Code Quality Checks"
    runs-on: ubuntu-latest
    steps:
      - name: "‚¨áÔ∏è Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "‚öôÔ∏è Setup pnpm"
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: "‚öíÔ∏è Setup Node.js v${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: "üì¶ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: Linting & Formatting Check (Biome)
        # Apex Standard for TS/JS quality control
        run: pnpm biome check --linter --formatter --max-warnings 0 .

      - name: "üîç TypeScript Strict Type Check"
        run: pnpm tsc --noEmit

      - name: "‚öóÔ∏è Run Unit & Component Tests (Vitest/Jest)"
        run: pnpm test:unit --coverage 

      - name: "üìä Upload Coverage Report to Codecov"
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true

  expo_configuration_check:
    name: "üì± Expo Configuration Sanity Check"
    needs: quality_gates
    runs-on: ubuntu-latest
    steps:
      - name: "‚¨áÔ∏è Checkout Repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è Setup pnpm"
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: "‚öíÔ∏è Setup Node.js v${{ env.NODE_VERSION }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: "üì¶ Install Dependencies"
        run: pnpm install --frozen-lockfile

      - name: Ensure Expo SDK is Installed Globally
        run: npm install -g expo-cli

      - name: Verify Expo Build Configuration Integrity (Prebuild Dry Run)
        # This ensures all native dependencies and configuration files are valid before a full build.
        run: npx expo prebuild --clean --platform all --dry-run
        env:
          EXPO_NO_DOTENV: 1
